● 프록시 IP 모니터링 허브 시스템 구현 문서

  📋 프로젝트 개요

  요구사항 분석

  - 목적: 프록시 서버들의 외부 IP 변경을 실시간 모니터링
  - 방식: 매분마다 각 프록시 서버에서 허브로 curl 요청 전송
  - 핵심 기능: remote_addr을 통한 실제 외부 IP 감지 및 변경 추적
  - 타임아웃: 80초 이상 미연결시 재부팅/오류 상태로 판단

  시스템 아키텍처

  [프록시 서버 1] ──┐
  [프록시 서버 2] ──┤
  [프록시 서버 3] ──┤── curl (매분) ──→ [허브 서버] ──→ [상태 조회]
       ...        ──┤                      ↓
  [프록시 서버 20]──┘                 [DB/메모리]

  🔧 기술 구현

  1. 핵심 API 설계

  엔드포인트: GET /proxy_server?name={프록시이름}

  요청 예시:
  curl http://허브서버:3001/proxy_server?name=proxy123

  응답 형식:
  {
    "success": true,
    "name": "proxy123",
    "remote_ip": "112.161.54.7",
    "ip_changed": false,
    "timestamp": "2025-08-08T05:23:08.287Z"
  }

  2. 허브 서버 핵심 로직

  // remote_addr 추출
  const remoteIP = req.headers['x-forwarded-for'] || req.connection.remoteAddress || 'unknown';

  // 이전 IP와 비교하여 변경 감지
  const prev = proxies.get(proxyName);
  const ipChanged = prev && prev.remote_ip !== remoteIP;

  // DB/메모리에 저장/업데이트
  proxies.set(proxyName, {
    name: proxyName,
    remote_ip: remoteIP,
    created_at: prev ? prev.created_at : now,
    updated_at: now
  });

  // IP 변경시 로그 출력
  if (ipChanged) {
    console.log(`🔄 IP변경 ${proxyName}: ${prev.remote_ip} → ${remoteIP}`);
  }

  3. 데이터베이스 스키마 (PostgreSQL)

  CREATE TABLE IF NOT EXISTS proxy_heartbeat (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    remote_ip VARCHAR(45) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  UPSERT 쿼리:
  INSERT INTO proxy_heartbeat (name, remote_ip, updated_at)
  VALUES ($1, $2, CURRENT_TIMESTAMP)
  ON CONFLICT (name)
  DO UPDATE SET remote_ip = $2, updated_at = CURRENT_TIMESTAMP

  📁 파일 구조

  핵심 구현 파일들

  hub-server/
  ├── ultra-simple-hub.js        # 메모리 버전 (즉시 테스트 가능)
  ├── simple-hub.js              # PostgreSQL DB 버전
  ├── simple-cron-example.sh     # cron 설정 자동화
  └── README.md                   # 상세 가이드

  1. ultra-simple-hub.js (메모리 버전)

  - 용도: 즉시 테스트 가능한 버전
  - 특징: DB 연결 불필요, 메모리에 저장
  - 포트: 3001
  - 장점: 설치 없이 바로 실행 가능

  2. simple-hub.js (DB 버전)

  - 용도: 실제 운영 환경용
  - 특징: PostgreSQL DB 연결
  - 지속성: 서버 재시작 후에도 데이터 유지

  3. simple-cron-example.sh (자동화 스크립트)

  # 매분마다 허브로 요청 전송
  * * * * * curl -s "http://허브서버:3001/proxy_server?name=프록시이름" > /dev/null 2>&1

  🚀 실행 방법

  1. 허브 서버 시작

  # 메모리 버전 (즉시 테스트)
  node ultra-simple-hub.js

  # DB 버전 (운영용)
  node simple-hub.js

  2. 각 프록시 서버에서 cron 설정

  # cron 편집
  crontab -e

  # 매분마다 실행 추가
  * * * * * curl -s "http://허브서버:3001/proxy_server?name=$(hostname)" > /dev/null 2>&1

  📊 모니터링 및 상태 조회

  상태 조회 API

  엔드포인트: GET /status

  응답 예시:
  {
    "total": 2,
    "proxies": [
      {
        "name": "proxy123",
        "remote_ip": "112.161.54.7",
        "last_seen": "2025-08-08T05:23:08.287Z",
        "created_at": "2025-08-08T05:23:08.287Z"
      },
      {
        "name": "proxy456",
        "remote_ip": "112.161.54.8",
        "last_seen": "2025-08-08T05:23:14.432Z",
        "created_at": "2025-08-08T05:23:14.432Z"
      }
    ],
    "timestamp": "2025-08-08T05:23:14.680Z"
  }

  실시간 로그 출력

  ✅ 업데이트 proxy123 [112.161.54.7] 2025-08-08 14:23:08
  🔄 IP변경 proxy123 [112.161.54.8] 2025-08-08 14:24:08
     이전: 112.161.54.7 → 현재: 112.161.54.8

  🔍 주요 기능 상세

  1. IP 변경 감지 로직

  - 같은 프록시 이름(name)에 대해 이전 IP와 현재 IP 비교
  - 변경 감지시 ip_changed: true 응답 및 로그 출력
  - 프록시 토글로 인한 외부 IP 변경을 실시간 추적

  2. 타임아웃 감지 (80초)

  - updated_at 기준으로 80초 이상 미연결시 타임아웃 처리
  - 재부팅 또는 오류 상황으로 판단
  - 상태 조회시 마지막 연결 시간 확인 가능

  3. 자동 생성/업데이트

  - 새로운 프록시 이름: created_at, updated_at 생성
  - 기존 프록시 이름: updated_at 업데이트, remote_ip 갱신

  ⚙️ 설정 및 커스터마이징

  포트 변경

  const PORT = 3001; // 원하는 포트로 변경

  DB 연결 설정 (PostgreSQL)

  const dbClient = new Client({
    host: 'localhost',
    port: 5432,
    user: 'proxy_admin',
    password: 'your_password',
    database: 'proxy_management'
  });

  타임아웃 기준 변경

  const TIMEOUT_MS = 80000; // 80초 (밀리초 단위)

  🧪 테스트 시나리오

  1. 기본 동작 테스트

  # 첫 번째 요청 (생성)
  curl "http://localhost:3001/proxy_server?name=test1"
  # 응답: {"success":true,"name":"test1","remote_ip":"127.0.0.1","ip_changed":false}

  # 두 번째 요청 (업데이트)
  curl "http://localhost:3001/proxy_server?name=test1"
  # 응답: {"success":true,"name":"test1","remote_ip":"127.0.0.1","ip_changed":false}

  2. IP 변경 시뮬레이션

  # 다른 IP에서 같은 이름으로 요청시 IP 변경 감지
  # (실제로는 프록시 토글로 인한 외부 IP 변경)

  3. 여러 프록시 관리

  # 여러 프록시 등록
  curl "http://localhost:3001/proxy_server?name=proxy001"
  curl "http://localhost:3001/proxy_server?name=proxy002"
  curl "http://localhost:3001/proxy_server?name=proxy003"

  # 전체 상태 확인
  curl "http://localhost:3001/status"

  📈 확장 가능성

  추가 기능 아이디어

  1. 웹 대시보드: 실시간 모니터링 UI
  2. 알림 시스템: IP 변경시 Slack/이메일 알림
  3. 통계 수집: IP 변경 빈도, 패턴 분석
  4. API 인증: 토큰 기반 접근 제어
  5. 클러스터링: 다중 허브 서버 운영

  성능 최적화

  - 메모리 사용량: ~10MB (20개 프록시 기준)
  - CPU 사용량: 극히 낮음 (이벤트 기반)
  - 네트워크: 매분 20개 요청 (각 ~500B)

  🔐 보안 고려사항

  기본 보안

  1. 내부 네트워크 배치: 허브 서버를 내부망에 설치
  2. 방화벽 설정: 필요한 포트만 개방
  3. 접근 제한: 알려진 프록시 서버 IP만 허용

  운영 보안

  1. 로그 관리: 민감 정보 로깅 방지
  2. 정기 백업: DB 정기 백업
  3. 모니터링: 비정상 접근 패턴 감지

  🛠️ 트러블슈팅

  일반적인 문제들

  1. 포트 충돌
  # 포트 사용 확인
  netstat -an | grep :3001
  # 다른 포트 사용 또는 기존 프로세스 종료
  2. DB 연결 실패
  # PostgreSQL 서비스 확인
  systemctl status postgresql
  # 연결 정보 확인
  3. cron 작업 미실행
  # cron 로그 확인
  tail -f /var/log/cron
  # 수동 테스트
  curl "http://허브서버:3001/proxy_server?name=test"

  📋 체크리스트

  구현 완료 항목

  - ✅ GET 방식 API 구현
  - ✅ remote_addr 자동 감지
  - ✅ IP 변경 감지 로직
  - ✅ 자동 생성/업데이트
  - ✅ 상태 조회 API
  - ✅ 메모리 버전 (즉시 테스트)
  - ✅ DB 버전 (운영용)
  - ✅ cron 설정 가이드
  - ✅ 실시간 로그 출력

  운영 준비 사항

  - PostgreSQL DB 설정
  - 방화벽 포트 개방
  - 각 프록시 서버에 cron 설정
  - 모니터링 대시보드 (선택사항)
  - 백업 정책 수립

  ---
  💡 핵심 포인트

  1. 단순함이 핵심: GET 요청 하나로 모든 기능 구현
  2. 즉시 실행 가능: 메모리 버전으로 바로 테스트
  3. 확장성 고려: DB 버전으로 운영 환경 지원
  4. 실시간 모니터링: IP 변경 즉시 감지 및 로그
  5. 자동화: cron으로 완전 자동 운영

  이 문서를 바탕으로 다른 AI가 동일한 시스템을 구현할 수 있습니다.