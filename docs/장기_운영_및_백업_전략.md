# 허브 서버 장기 운영 및 백업 전략

## 1. 시스템 규모 예측

### 1.1 예상 성장 규모
- **프록시**: 최대 500개 (고정)
- **키워드**: 최대 30,000개 (6개월 내)
- **일일 처리량**: 약 100,000건 할당
- **연간 데이터**: 약 3,650만 건

### 1.2 데이터 증가율
```
일일: 100,000 rows
월간: 3,000,000 rows  
연간: 36,500,000 rows
```

## 2. 데이터 아카이빙 전략

### 2.1 90일 자동 아카이빙 정책
- 90일 이상 된 로그 데이터는 아카이브 테이블로 이동
- 아카이브 후 압축 저장
- 필요시에만 조회 가능한 콜드 스토리지

### 2.2 아카이빙 대상 테이블
- `v1_hub_work_allocations` (가장 큰 증가율)
- `v1_hub_client_activity_logs`
- `v1_hub_proxy_toggle_logs`
- `v1_hub_work_slots_history`

## 3. 파티셔닝 전략

### 3.1 월별 파티셔닝
```sql
-- 메인 테이블을 파티션 테이블로 변환
CREATE TABLE v1_hub_work_allocations_partitioned (
    LIKE v1_hub_work_allocations INCLUDING ALL
) PARTITION BY RANGE (work_date);

-- 월별 파티션 생성 (예: 2025년 8월)
CREATE TABLE v1_hub_work_allocations_2025_08 
PARTITION OF v1_hub_work_allocations_partitioned
FOR VALUES FROM ('2025-08-01') TO ('2025-09-01');
```

### 3.2 자동 파티션 관리
- 매월 자동으로 새 파티션 생성
- 90일 이상 된 파티션은 아카이브 후 DROP

## 4. 백업 및 아카이빙 구현

### 4.1 아카이브 테이블 구조
```sql
-- 아카이브 테이블 (압축 적용)
CREATE TABLE v1_hub_work_allocations_archive (
    LIKE v1_hub_work_allocations INCLUDING ALL
) WITH (autovacuum_enabled = false);

ALTER TABLE v1_hub_work_allocations_archive SET (
    toast_compression = 'lz4',
    fillfactor = 100
);
```

### 4.2 자동 아카이빙 프로시저
```sql
CREATE OR REPLACE FUNCTION archive_old_allocations()
RETURNS void AS $$
BEGIN
    -- 90일 이상 된 데이터를 아카이브로 이동
    INSERT INTO v1_hub_work_allocations_archive
    SELECT * FROM v1_hub_work_allocations
    WHERE work_date < CURRENT_DATE - INTERVAL '90 days';
    
    -- 원본에서 삭제
    DELETE FROM v1_hub_work_allocations
    WHERE work_date < CURRENT_DATE - INTERVAL '90 days';
    
    -- 통계 업데이트
    ANALYZE v1_hub_work_allocations;
END;
$$ LANGUAGE plpgsql;
```

## 5. 일일 유지보수 스케줄

### 5.1 크론 작업 설정
```bash
# 매일 새벽 3시 아카이빙 실행
0 3 * * * /home/techb/hub-coupang-v1/scripts/daily-archive.sh

# 매주 일요일 새벽 4시 백업
0 4 * * 0 /home/techb/hub-coupang-v1/scripts/weekly-backup.sh

# 매월 1일 새벽 2시 파티션 생성
0 2 1 * * /home/techb/hub-coupang-v1/scripts/monthly-partition.sh
```

## 6. 성능 최적화

### 6.1 인덱스 전략
```sql
-- 90일 이내 데이터만 인덱싱
CREATE INDEX idx_allocations_recent 
ON v1_hub_work_allocations (work_date, status)
WHERE work_date >= CURRENT_DATE - INTERVAL '90 days';

-- 자주 조회되는 컬럼 복합 인덱스
CREATE INDEX idx_allocations_lookup
ON v1_hub_work_allocations (allocation_key, work_date)
WHERE status = 'allocated';
```

### 6.2 통계 테이블
```sql
-- 일별 집계 테이블 (빠른 대시보드용)
CREATE TABLE v1_hub_daily_stats (
    stat_date DATE PRIMARY KEY,
    total_allocations BIGINT,
    completed_count BIGINT,
    expired_count BIGINT,
    avg_execution_time_ms INTEGER,
    unique_clients INTEGER,
    unique_keywords INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 7. 스토리지 예측

### 7.1 연간 스토리지 요구사항
```
원본 데이터 (90일): ~9GB
아카이브 데이터 (275일): ~25GB (압축 후 ~10GB)
인덱스: ~5GB
총 예상: ~25GB/년
```

### 7.2 5년 장기 계획
- 1년차: 25GB
- 3년차: 75GB
- 5년차: 125GB
- 권장 디스크: 500GB SSD

## 8. 모니터링 지표

### 8.1 핵심 모니터링 항목
- 테이블 크기 증가율
- 쿼리 응답 시간
- 아카이빙 작업 소요 시간
- 디스크 사용률

### 8.2 경고 임계값
- 테이블 크기 > 10GB: 경고
- 쿼리 시간 > 1초: 경고
- 디스크 사용률 > 70%: 경고
- 아카이빙 실패: 즉시 알림

## 9. 재해 복구 계획

### 9.1 백업 전략
- 일일: 증분 백업 (최근 변경분만)
- 주간: 전체 백업
- 월간: 오프사이트 백업

### 9.2 복구 시간 목표
- RTO (복구 시간 목표): 4시간
- RPO (복구 시점 목표): 24시간

## 10. 구현 우선순위

### Phase 1 (즉시)
1. 아카이빙 테이블 생성
2. 일일 아카이빙 스크립트 작성
3. 크론 작업 설정

### Phase 2 (1개월 내)
1. 파티셔닝 구현
2. 자동 파티션 관리
3. 모니터링 대시보드

### Phase 3 (3개월 내)
1. 백업 자동화
2. 재해 복구 테스트
3. 성능 튜닝

---
**작성일**: 2025-08-09  
**예상 구현 기간**: 3개월  
**유지보수 주기**: 월 1회